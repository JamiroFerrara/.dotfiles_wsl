Select (Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drGravit√†' AND CODICE = CON.GRAVITA) As GRAVITA,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drSiNoTutte' And CODICE = CON.APPLICAZIONE_AUTOMATICA) As TipoApplicazione,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'rbSiNo' And CODICE = CON.CHIUSURA_ANOMALIA_AUTO) As CHIUSURA_ANOMALIA_AUTO,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drEffettuazione' And CODICE = CON.TIPO_EFFETTUAZIONE) As TIPO_EFFETTUAZIONE,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drSiNoAvviso' And CODICE = CON.AVVISO_SCADENZA) As AVVISO_SCADENZA,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drSiNoAvviso' And CODICE = CON.AVVISO_SCAD_SUPERVISORE) As AVVISO_SCAD_SUPERVISORE,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA Where TIPO = 'drSiNoAvviso' And CODICE = CON.AVVISO_SCAD_RISKCONTROLLER) As AVVISO_SCAD_RISKCONTROLLER,
TES.TITOLO_AGGIUNTIVO, TET.DESCRIZIONE As COMPETESEC,
Case When CLN.NomeGerarchico Is Null Then 'Non Classificati' Else CLN.NomeGerarchico End As Classificazione,
CON.ID As ID_CFG,
Case When CON.ID_SOTTOMODULO_RAPPORTO < 0 Then 'No' When CON.ID_SOTTOMODULO_RAPPORTO Is Null Then 'No' When Not CON.ID_SOTTOMODULO_RAPPORTO Is Null Then 'Si' End As PresenzaSottomodulo,
Case When CON.ID_CORRELAZIONE > 0 Then 'Si' Else 'No' End As PresenzaCorrela,
Case When CON.ATTIVARE_CAUSALI = '0' Then 'Si' When CON.ATTIVARE_CAUSALI = '1' Then 'No' End As PresenzaCausali,
TET2.DESCRIZIONE As Supervisore, TET3.DESCRIZIONE As RiskController, TES.ID As IdTestata,
(Select DESCRIZIONE From FCVWSCT1.TBConfig.dbo.CON_DECODIFICA WHERE TIPO = 'drStatoConf' And CODICE = CON.STATO) As Stato,
Max(CON.VERSIONE) As VERSIONE, CON.STATO As CodStato, CON.TIPO,
(Select Count(*) From CON_ESECUZIONI_CON_3599 ESE
Where ESE.COD_ABI = CON.COD_ABI And ESE.ID_CFG = TES.ID And ESE.VERSIONE = CON.VERSIONE) As ESECUZIONI,
IsNull((Select Count(*) From CON_ESITI_3599 ESI
Where ESI.COD_ABI = CON.COD_ABI And ESI.ID_CFG = TES.ID And ESI.TIPO = 'C' And ESI.VERSIONE = CON.VERSIONE), 0) As NUM_ESITI,
(Select(Select Count(*) From CON_CFG_COLLEGAMENTI_3599 COL
Where COL.COD_ABI = CON.COD_ABI And COL.VERSIONE = TES.VERSIONE And COL.ID = TES.ID) +
(Select Count(*) From CON_ESECUZIONI_COLLEGAMENTI_3599 CEC
Where CEC.COD_ABI = CON.COD_ABI And CEC.ID = TES.ID)) As Collegati,
CLN.NomeGerarchico As IDENTIFICAZIONE, TES.SB_GuidOriginale, CON.DATA_VERSIONE, CON.DATA_STORICIZZAZIONE, CON.ARGOMENTO, TIP.DESCRIZIONE As TipologiaControllo,
Case When Not TES.TITOLO_AGGIUNTIVO Is Null And TES.TITOLO_AGGIUNTIVO <> '' Then SIS.SB_Titolo + ' - ' + TES.TITOLO_AGGIUNTIVO Else SIS.SB_Titolo End As TitoloControllo, TET.ID AS COMPETENCE_ID, CON.FREQUENZA
From CON_CFG_TESTATA_3599 TES
Left Join CON_SUPERVISORI_SELEZIONATI_3599 SUS
On TES.ID = SUS.ID_CFG_TESTATA And SUS.VERSIONE = TES.VERSIONE
Left Join CON_TESTATA_TABELLE_3599 TET2
On SUS.ID_TAB_TESTATA = TET2.ID
Left Join CON_RISKCONTROLLER_SELEZIONATI_3599 CRS
On TES.ID = CRS.ID_CFG_TESTATA And TES.VERSIONE = CRS.VERSIONE
Left Join CON_TESTATA_TABELLE_3599 TET3
On CRS.ID_TAB_TESTATA = TET3.ID
--Inner Join SIOd_VW_SB_Extended_Light SVE
--On TES.SB_GuidOriginale = SVE.SB_Guid
Left Outer Join CON_COMPETENZE_ESECUZIONE_3599 COM
On TES.ID = COM.ID_CFG_TESTATA And TES.VERSIONE = COM.VERSIONE
Left Outer Join CON_TESTATA_TABELLE_3599 TET
On COM.ID_TAB_TESTATA = TET.ID

-- NOTE: This is null
left Join SIOd_SB_SchedaBase_3599 SIS
On TES.SB_GuidOriginale = SIS.SB_Guid
--
left Join CON_CFG_CONTROLLI_3599 CON
On TES.COD_ABI = CON.COD_ABI And TES.ID = CON.ID_TESTATA And TES.VERSIONE = CON.VERSIONE
Left Join CON_CFG_COLLEGAMENTI_3599 COL
On CON.COD_ABI = COL.COD_ABI And CON.ID = COL.ID And CON.VERSIONE = COL.VERSIONE And CON.TIPO = COL.TIPO
Left Join SIOd_ID_IdentificazioniScheda_3599 SII
On SIS.SB_Guid = SII.ID_SB_Guid And SII.ID_TipoClassificazione = 'P'
Left Join CLA_NOMIGERARCHICI_3599 CLN
On SII.ID_IdNodo = CLN.CodiceNodo
Left Join SIOd_CM_CompetenzeScheda_3599 SCM
On TES.SB_GuidOriginale = SCM.CM_SB_Guid
Left Join(Select RIS.ID_RISTRU, RES.ENTITA
From CON_RISSTRU_3599 RIS
Inner Join CON_RISSTRU_ENTITA_3599 RES
On RIS.ID_RISTRU = RES.ID_RISTRU) ARI
On CON.ID_AVVISI_AGGIUNTIVI = ARI.ID_RISTRU
Left Join(Select RIS.ID_RISTRU, RES.ENTITA
From CON_RISSTRU_3599 RIS
Left Join CON_RISSTRU_ENTITA_3599 RES
On RIS.ID_RISTRU = RES.ID_RISTRU) ARR
On CON.ID_AVVISI_RAPPORTO = ARR.ID_RISTRU
Left Join(Select RIS.ID_RISTRU, RES.ENTITA
From CON_RISSTRU_3599 RIS
Left Join CON_RISSTRU_ENTITA_3599 RES
On RIS.ID_RISTRU = RES.ID_RISTRU) ARV
On CON.ID_VISIBILITA_ESITI = ARV.ID_RISTRU
Left Join(Select RIS.ID_RISTRU, RES.ENTITA
From CON_RISSTRU_3599 RIS
Left Join CON_RISSTRU_ENTITA_3599 RES
On RIS.ID_RISTRU = RES.ID_RISTRU) ARS
On CON.ID_AVVISI_AGGIUNTIVI_SUPERVISORE = ARS.ID_RISTRU
Left Join(Select RIS.ID_RISTRU, RES.ENTITA
From CON_RISSTRU_3599 RIS
Left Join CON_RISSTRU_ENTITA_3599 RES
On RIS.ID_RISTRU = RES.ID_RISTRU) ARK
On CON.ID_AVVISI_SCADENZA_RISKCONTROLLER = ARK.ID_RISTRU
Left Join CON_TIPOLOGIA_CONTROLLI_3599 TIP
On CON.TIPOLOGIA = TIP.CODICE
Left Outer Join(Select Distinct COM.ID_CFG_TESTATA, RES.ENTITA
From CON_COMPETENZE_ESECUZIONE_3599 COM
Left Join CON_COMPETENZA_ESECUZIONE_3599 COA
On COM.ID_TAB_TESTATA = COA.ID
Left Join CON_RISSTRU_ENTITA_3599 RES
On COA.ID_CHI_TUTTO = RES.ID_RISTRU Or COA.ID_CHI_ESITA = RES.ID_RISTRU) COE
ON TES.ID = COE.ID_CFG_TESTATA
Left Outer Join(Select Distinct SUS.ID_CFG_TESTATA, RES.ENTITA
From CON_SUPERVISORI_SELEZIONATI_3599 SUS
Left Join CON_SUPERVISORI_3599 SUP
On SUS.ID_TAB_TESTATA = SUP.ID
Left Join CON_RISSTRU_ENTITA_3599 RES
On SUP.ID_SUPERVISORE = RES.ID_RISTRU) CSU
On TES.ID = CSU.ID_CFG_TESTATA
Left Outer Join(Select Distinct CRS.ID_CFG_TESTATA, RES.ENTITA
From CON_RISKCONTROLLER_SELEZIONATI_3599 CRS
Left Join CON_RISKCONTROLLER_3599 CRI
On CRS.ID_TAB_TESTATA = CRI.ID
Left Join CON_RISSTRU_ENTITA_3599 RES
On CRI.ID_RISKCONTROLLER = RES.ID_RISTRU) COR
On TES.ID = COR.ID_CFG_TESTATA
LEFT OUTER JOIN
(
SELECT
    DISTINCT CON_COMPETENZE_ESECUZIONE.ID_CFG_TESTATA, CON_RISSTRU_ENTITA.ENTITA
FROM
    [CON_COMPETENZE_ESECUZIONE_3599] as CON_COMPETENZE_ESECUZIONE
    inner JOIN [CON_COMPETENZA_ESECUZIONE_3599] as CON_COMPETENZA_ESECUZIONE 
    ON CON_COMPETENZE_ESECUZIONE.ID_TAB_TESTATA = CON_COMPETENZA_ESECUZIONE.ID
    inner JOIN [CON_RISSTRU_ENTITA_3599] as CON_RISSTRU_ENTITA 
    ON CON_COMPETENZA_ESECUZIONE.ID_CHI_TUTTO = CON_RISSTRU_ENTITA.ID_RISTRU 
    OR CON_COMPETENZA_ESECUZIONE.ID_CHI_ESITA = CON_RISSTRU_ENTITA.ID_RISTRU
) as COMP_ESEC
ON TES.ID = COMP_ESEC.ID_CFG_TESTATA
-- where TES.ID = '21154253-490d-4c65-8b7a-35d77fa35890'
--where SIS.SB_Guid = 'e0c2a102-20d6-45fd-9d0f-b036ef27ff5a' and TES.ID = '3661FC25-FDAF-4EB7-92DF-461AF609010A'
-- where CON.ID = 'f067c68a-adae-47d4-aa77-9c7cc184f18f'
where CON.FREQUENZA <> 0
Group By CON.GRAVITA, CON.APPLICAZIONE_AUTOMATICA, CON.CHIUSURA_ANOMALIA_AUTO, CON.TIPO_EFFETTUAZIONE, CON.AVVISO_SCADENZA, CON.AVVISO_SCAD_SUPERVISORE, CON.AVVISO_SCAD_RISKCONTROLLER, TES.TITOLO_AGGIUNTIVO,
TET.DESCRIZIONE, TET.ID, CLN.NomeGerarchico, CON.ID, CON.ID_SOTTOMODULO_RAPPORTO, CON.ID_CORRELAZIONE, CON.ATTIVARE_CAUSALI, TET2.DESCRIZIONE, TET3.DESCRIZIONE, TES.ID, CON.Stato, CON.TIPO, CON.COD_ABI,
CON.VERSIONE, TES.VERSIONE, TES.SB_GuidOriginale, CON.DATA_VERSIONE, CON.DATA_STORICIZZAZIONE, CON.ARGOMENTO, TIP.DESCRIZIONE, SIS.SB_Titolo, CON.FREQUENZA
Order By TitoloControllo

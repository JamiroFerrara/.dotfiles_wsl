SELECT

    CASE
        WHEN NOT TITOLO_AGGIUNTIVO IS NULL AND TITOLO_AGGIUNTIVO <> '' THEN SB_Titolo + ' - ' + TITOLO_AGGIUNTIVO
        ELSE SB_Titolo
    END AS TitoloSchedaRI,
    cla1.NomeGerarchico AS Identificazione,
    pesoFr.PESO AS Peso,
    pesoFr.FREQUENZA AS Frequenza,
    pesoFr.RISCHIO AS RISCHIO_POTENZIALE,
    testa.ID,

    schedari.ID AS IDRI,
    TITOLO_AGGIUNTIVO,
    MAX(testa.VERSIONE) AS VERSIONE,
    (SELECT DESCRIZIONE FROM FCVWSCT1.TBConfig.dbo.CON_DECODIFICA WHERE TIPO = 'drStatoConf' AND CODICE = schedari.STATO) AS Stato,
    COUNT(*) AS CONTROLLI_ASSOCIATI,
    schedari.Stato AS CodStato,
    idcla.NomeGerarchico AS CATEGORIARISCHIO,
    (SELECT DESCRIZIONE FROM CON_TIPOLOGIA_RISCHIO_3599 AS tiprischio WHERE tiprischio.CODICE = schedari.TIPOLOGIA) AS TIPOLOGIARISCHIO,
    schedari.DATA_VERSIONE,
    schedari.DATA_STORICIZZAZIONE,
    schedari.ID_PESO_FREQUENZA,
    (SELECT COUNT(*) FROM CON_ESECUZIONI_RI_3599 AS esecclo
        WHERE esecclo.ID_CFG = testa.ID
        AND esecclo.COD_ABI = schedari.COD_ABI
        AND esecclo.VERSIONE = schedari.VERSIONE) AS ESECUZIONI
FROM
    CON_CFG_TESTATA_3599 AS testa
INNER JOIN
    SIOd_SB_SchedaBase_3599 AS schedab ON testa.SB_GuidOriginale = schedab.SB_Guid

INNER JOIN
    CON_CFG_SCHEDARISCHIO_3599 AS schedari ON schedari.COD_ABI = testa.COD_ABI AND schedari.ID_TESTATA = testa.ID AND schedari.VERSIONE = testa.VERSIONE
LEFT JOIN
    CON_PESI_FREQUENZE_3599 AS pesoFr ON schedari.ID_PESO_FREQUENZA = pesoFr.ID
LEFT JOIN
    CON_CFG_COLLEGAMENTI_3599 ctrl ON ctrl.ID_CFG_COLLEGATA = schedari.ID AND ctrl.COD_ABI = schedari.COD_ABI AND ctrl.TIPO = 'C'
LEFT JOIN
    SIOd_ID_IdentificazioniScheda_3599 cla ON cla.ID_SB_Guid = schedab.SB_Guid AND cla.ID_TipoClassificazione = 'P'
LEFT JOIN
    CLA_NOMIGERARCHICI_3599 cla1 ON cla.ID_IdNodo = cla1.CodiceNodo
LEFT JOIN
    CLA_NOMIGERARCHICI_3599 idcla ON schedari.IDENTIFICAZIONE_CATEGORIA = idcla.CodiceNodo
LEFT JOIN
    SIOd_CM_CompetenzeScheda_3599 CM ON CM.[CM_SB_Guid] = testa.SB_GuidOriginale AND CM.[CM_TS05_Id] = testa.COMPETENZA_EFFETTUAZIONE
LEFT OUTER JOIN
    (
    SELECT DISTINCT
        CON_COMPETENZE_ESECUZIONE.ID_CFG_TESTATA,
        CON_RISSTRU_ENTITA.ENTITA
    FROM
        CON_COMPETENZE_ESECUZIONE_3599 AS CON_COMPETENZE_ESECUZIONE
    INNER JOIN
        CON_COMPETENZA_ESECUZIONE_3599 AS CON_COMPETENZA_ESECUZIONE ON CON_COMPETENZE_ESECUZIONE.ID_TAB_TESTATA = CON_COMPETENZA_ESECUZIONE.ID
    INNER JOIN
        CON_RISSTRU_ENTITA_3599 AS CON_RISSTRU_ENTITA ON CON_COMPETENZA_ESECUZIONE.ID_CHI_TUTTO = CON_RISSTRU_ENTITA.ID_RISTRU OR CON_COMPETENZA_ESECUZIONE.ID_CHI_ESITA = CON_RISSTRU_ENTITA.ID_RISTRU
    ) AS COMP_ESEC ON testa.ID = COMP_ESEC.ID_CFG_TESTATA
LEFT OUTER JOIN
    (

    SELECT DISTINCT
        CON_SUPERVISORI_SELEZIONATI.ID_CFG_TESTATA,
        CON_RISSTRU_ENTITA.ENTITA
    FROM
        CON_SUPERVISORI_SELEZIONATI_3599 AS CON_SUPERVISORI_SELEZIONATI
    INNER JOIN
        CON_SUPERVISORI_3599 AS CON_SUPERVISORI ON CON_SUPERVISORI_SELEZIONATI.ID_TAB_TESTATA = CON_SUPERVISORI.ID
    INNER JOIN
        CON_RISSTRU_ENTITA_3599 AS CON_RISSTRU_ENTITA ON CON_SUPERVISORI.ID_SUPERVISORE = CON_RISSTRU_ENTITA.ID_RISTRU
    ) AS COMP_SUP ON testa.ID = COMP_SUP.ID_CFG_TESTATA
    group by TITOLO_AGGIUNTIVO, SB_Titolo, cla1.NomeGerarchico, pesoFr.PESO, pesoFr.FREQUENZA, pesoFr.RISCHIO, testa.ID, schedari.ID, schedari.STATO, idcla.NomeGerarchico, schedari.TIPOLOGIA, schedari.DATA_VERSIONE, schedari.DATA_STORICIZZAZIONE, schedari.ID_PESO_FREQUENZA, schedari.COD_ABI, schedari.VERSIONE

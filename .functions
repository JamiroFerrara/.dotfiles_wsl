#!/bin/zsh

# [[ Run ]]
# If one argument is passed, run the script with that name
# If no arguments are passed, use fzf to search the scripts folder
# and then run the script
function r() {
    # if one argument passed
    if [ $# -eq 1 ]; then
        echo "Running $1"
        # if file exists
        if [ -f ./scripts/$1.sh ]; then
            ./scripts/$1.sh
        fi
    else
        # fzf search the scripts folder and then run the script
        script=$(exa ./scripts | fzf)
        if [ -n "$script" ]; then
            ./scripts/$script
        fi
    fi
}

# [[ Make ]]
# If one argument is passed, run the script with that name
# If no arguments are passed, use fzf to list makefile options
# and then run
function m() {
    if [ $# -eq 0 ]; then
        make_options=$(grep -oP '^[a-zA-Z0-9_-]+(?=:)' Makefile | fzf)
        make "$make_options"
    else
        make "$1"
    fi
}

# Makes a directory and then cd into it
function md() {
    mkdir $1
    cd $1
}

# Searches chrome for the query
function s() {
    query="https://www.google.com/search?q="+$*
    chrome.exe $query
}

# Searches chrome for the query with lucky search
function sl() {
    query="https://duckduckgo.com/?q=!ducky+"+$*
    chrome.exe $query
}

# Untar a file
function utar() {
    tar xzf $1
    rm $1
}

# Create a new script file
function scr {
    touch $1.sh
    chmod +x $1.sh
    nvim $1.sh
}

# Backup a file
function backup() { 
    cp -- "$1"{,.bak};
}

# Time the shell startup
function timezsh() {
  shell=${1-$SHELL}
  for i in $(seq 1 10); do /usr/bin/time $shell -i -c exit; done
}

# Ranger cd
function ranger-cd {
    tempfile="$(mktemp -t tmp.XXXXXX)"
    /usr/bin/ranger --choosedir="$tempfile" "${@:-$(pwd)}"
    test -f "$tempfile" &&
    if [ "$(cat -- "$tempfile")" != "$(echo -n `pwd`)" ]; then
        cd -- "$(cat "$tempfile")"
    fi  
    rm -f -- "$tempfile"
}

alias flyl='fly-list'
function fly-list {
    list='
fly machines list
fly apps list
fly status --all
fly version
fly help
    '
    selected=$(echo "$list" | fzf)
    if [ -n "$selected" ]; then
        eval "$selected"
    fi
}

function remove-empty-directories {
    find . -type d -empty -exec rmdir -v {} +
}

function upload_file() {
    local file_path="$1"
    local api_url="http://localhost:3001/upload"  # Replace PORT with your actual port number
    # Check if the file exists
    if [[ ! -f "$file_path" ]]; then
        echo "File not found: $file_path"
        return 1
    fi
    # Upload the file using curl
    local response
    response=$(curl -s -X POST "$api_url" -F "files=@$file_path")
    # Check if the upload was successful
    if [[ $? -eq 0 ]]; then
        echo "Upload successful!"
        echo "Response: $response"
    else
        echo "Upload failed."
        return 1
    fi
}

function send() {
    # Check if fzf and curl are installed
    if ! command -v fzf &> /dev/null; then
        echo "fzf could not be found. Please install it."
        return 1
    fi
    if ! command -v curl &> /dev/null; then
        echo "curl could not be found. Please install it."
        return 1
    fi
    # Use fzf to select a file in the current directory and its subdirectories
    FILE=$(find . -type f | fzf --height 40% --reverse --preview 'cat {}' --preview-window=up:30%)
    
    # Check if a file was selected
    if [ -z "$FILE" ]; then
        echo "No file selected."
        return 1
    fi
    # Upload the file to 0x0.st with a custom User-Agent
    RESPONSE=$(curl -F "file=@$FILE" -H "User-Agent: stiwie/9999" https://0x0.st)
    
    # Check if the upload was successful
    if [[ $? -eq 0 ]]; then
        echo "File uploaded successfully!"
        echo "$RESPONSE"
        
        # Copy the response (upload link) to the clipboard using PowerShell
        echo "$RESPONSE" | clip.exe
        
        echo "Upload link copied to clipboard."
    else
        echo "Failed to upload the file."
        return 1
    fi
}

alias n='nvim'
alias vim='nvim'
alias vi='nvim'

nvim() {
    local orig_cmd
    orig_cmd=$(tmux show-option -gqv default-command)

    # Temporarily unset default-command
    tmux set-option -g default-command ""

    # Respawn current pane running nvim
    tmux respawn-pane -k "nvim \"$@\""

    # Immediately restore default-command (tmux commands are synchronous)
    if [ -n "$orig_cmd" ]; then
      tmux set-option -g default-command "$orig_cmd"
    fi
}
